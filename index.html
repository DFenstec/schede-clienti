<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Schede clienti</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;margin:0;background:#f7f7f8}
    header{background:#0f172a;color:#fff;padding:16px 20px}
    h1{font-size:20px;margin:0}
    .wrap{padding:16px;max-width:1200px;margin:0 auto}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    input{flex:1;min-width:260px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
    .table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;vertical-align:top}
    .table th{background:#f1f5f9;text-align:left}
    a.btn{display:inline-block;padding:6px 10px;border:1px solid #0f172a;border-radius:8px;text-decoration:none}
    .muted{color:#64748b}
  </style>
</head>
<body>
  <header><h1>Schede clienti</h1></header>

  <div class="wrap">
    <div class="tools">
      <input id="q" placeholder="Cerca (evita apostrofi e punteggiatura: es. erbolario)" />
    </div>
    <p class="muted" id="status">Caricamento database...</p>

    <table class="table" id="t">
      <thead>
        <tr>
          <th>Agente</th>
          <th>Descr. 1</th>
          <th>Descr. 2</th>
          <th>Tipologia</th>
          <th>Comune</th>
          <th>Provincia</th>
          <th>P. IVA</th>
          <th>Email</th>
          <th>Modulo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // METTI QUI IL TUO LINK FORMS (BASE)
  const FORM_BASE =
    "https://forms.office.com/Pages/ResponsePage.aspx?id=nKtCoyvbA0i4vGbx7zHXWHvai3XR44xKmD6FRWRkL9pUODc4UVZES1g2SFpFMzdRSEhKNkVER0czQyQlQCN0PWcu";

  // MAPPATURA DEI CAMPI PRECOMPILATI (quelli che hai giÃ  definito nel link)
  const KEYS = {
    descr1: "r444f7f325e7f494884a64210762d71cf",
    descr2: "rc51bef4dd505413ebc19b4d510a3365a",
    comune: "r26540616401e4f999c44de10ddc004ee",
    provincia: "r8df9a2a8446640338ce40a1c53c513d7",
    tipologia: "rbafce5adc91849a2a8e7921033a3f0d3",
    piva: "rc51aa2d7137f43a08b841f5ff85ce8c3",
    email: "r1addcad129b44b3cb2220834a33335d5",
    agente: "r59bc1e759dc143c48cba2b322870aea3"
  };

  function norm(s){
    return (s||"").toString().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9 ]+/g," ").replace(/\s+/g," ").trim();
  }

  // Costruisce il link usando encodeURIComponent: niente "+" nel modulo
  function buildFormUrl(row){
    const url = new URL(FORM_BASE);
    const add = (key, val) => {
      if(val === null || val === undefined) return;
      const v = String(val).trim();
      if(!v) return;
      url.searchParams.set(key, v);
    };

    add(KEYS.descr1, row["Descr. 1"] || row["Descr1"] || row["descr1"]);
    add(KEYS.descr2, row["Descr. 2"] || row["Descr2"] || row["descr2"]);
    add(KEYS.comune, row["Comune"] || row["comune"]);
    add(KEYS.provincia, row["Provincia"] || row["provincia"]);
    add(KEYS.tipologia, row["Tipologia punto vendita"] || row["Tipologia"] || row["tipologia"]);
    add(KEYS.piva, row["P.Iva"] || row["P.iva"] || row["PIVA"] || row["piva"]);
    add(KEYS.email, row["Email punto vendita"] || row["Email"] || row["email"]);
    add(KEYS.agente, row["Agente"] || row["agente"]);

    return url.toString();
  }

  // Parser CSV semplice (gestisce virgolette)
  function parseCSV(text){
    const rows = [];
    let i = 0, field = "", row = [], inQuotes = false;

    while(i < text.length){
      const c = text[i];

      if(inQuotes){
        if(c === '"' && text[i+1] === '"'){ field += '"'; i += 2; continue; }
        if(c === '"'){ inQuotes = false; i++; continue; }
        field += c; i++; continue;
      }else{
        if(c === '"'){ inQuotes = true; i++; continue; }
        if(c === ','){ row.push(field); field=""; i++; continue; }
        if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
        if(c === '\r'){ i++; continue; }
        field += c; i++; continue;
      }
    }
    if(field.length || row.length){ row.push(field); rows.push(row); }
    return rows;
  }

  async function load(){
    const res = await fetch("./database.csv?v=" + Date.now());
    if(!res.ok) throw new Error("CSV non trovato: carica database.csv nella root del repo");
    const text = await res.text();
    const grid = parseCSV(text);
    const headers = grid[0].map(h => h.trim());
    const data = grid.slice(1).filter(r => r.some(x => (x||"").trim() !== "")).map(r => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
      return obj;
    });

    const tbody = document.querySelector("#t tbody");
    tbody.innerHTML = "";

    for(const row of data){
      const tr = document.createElement("tr");
      const agente = row["Agente"] || "";
      const d1 = row["Descr. 1"] || "";
      const d2 = row["Descr. 2"] || "";
      const comune = row["Comune"] || "";
      const provincia = row["Provincia"] || "";
      const tipologia = row["Tipologia punto vendita"] || row["Tipologia"] || "";
      const piva = row["P.Iva"] || "";
      const email = row["Email punto vendita"] || "";

      const key = norm([agente,d1,d2,comune,provincia,tipologia,piva,email].join(" "));
      tr.setAttribute("data-key", key);

      const url = buildFormUrl(row);

      tr.innerHTML = `
        <td>${agente}</td>
        <td>${d1}</td>
        <td>${d2}</td>
        <td>${tipologia}</td>
        <td>${comune}</td>
        <td>${provincia}</td>
        <td>${piva}</td>
        <td>${email}</td>
        <td><a class="btn" href="${url}" target="_blank" rel="noopener">Apri modulo</a></td>
      `;
      tbody.appendChild(tr);
    }

    document.getElementById("status").textContent = "Caricati " + data.length + " punti vendita.";

    const q = document.getElementById("q");
    q.addEventListener("input", () => {
      const qq = norm(q.value);
      for(const tr of document.querySelectorAll("#t tbody tr")){
        tr.style.display = tr.getAttribute("data-key").includes(qq) ? "" : "none";
      }
    });
  }

  load().catch(err => {
    document.getElementById("status").textContent = "Errore: " + err.message;
  });
</script>
</body>
</html>
